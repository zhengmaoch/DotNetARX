# ğŸ›¡ï¸ çº¿ç¨‹å®‰å…¨ä¼˜åŒ–å»ºè®®

## é—®é¢˜åˆ†æ

å½“å‰é¡¹ç›®çš„å¼‚æ­¥æ“ä½œå­˜åœ¨ä¸¥é‡çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š

### 1. AutoCADäº‹åŠ¡ä¸æ”¯æŒå¤šçº¿ç¨‹
```csharp
// âŒ å½“å‰é—®é¢˜ä»£ç  - AsyncOperations.cs
public async Task<AsyncOperationResult<bool>> MoveEntityAsync(...)
{
    var result = await Task.Run(() =>
    {
        // è¿™é‡Œåœ¨åå°çº¿ç¨‹è°ƒç”¨AutoCAD APIï¼Œä¼šå¯¼è‡´è·¨çº¿ç¨‹å¼‚å¸¸
        return MoveEntity(entityId, fromPoint, toPoint);
    }, cancellationToken);
}
```

### 2. ç¼ºä¹æ–‡æ¡£é”å®šæœºåˆ¶
AutoCADçš„æ–‡æ¡£å¯¹è±¡ä¸UIçº¿ç¨‹ç»‘å®šï¼Œåå°çº¿ç¨‹è®¿é—®éœ€è¦è·å–æ–‡æ¡£é”ã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. å®ç°æ­£ç¡®çš„å¼‚æ­¥æ¨¡å¼

```csharp
/// <summary>
/// çº¿ç¨‹å®‰å…¨çš„å¼‚æ­¥å®ä½“æ“ä½œæœåŠ¡
/// </summary>
public class ThreadSafeAsyncEntityService
{
    /// <summary>
    /// æ­£ç¡®çš„å¼‚æ­¥ç§»åŠ¨å®ä½“å®ç°
    /// </summary>
    public async Task<AsyncOperationResult<bool>> MoveEntityAsync(
        ObjectId entityId,
        Point3d fromPoint,
        Point3d toPoint,
        CancellationToken cancellationToken = default)
    {
        var startTime = DateTime.Now;
        
        try
        {
            // åœ¨UIçº¿ç¨‹ä¸Šæ‰§è¡ŒAutoCADæ“ä½œ
            var result = await Task.FromResult(false);
            
            // ä½¿ç”¨Application.Invokeç¡®ä¿åœ¨æ­£ç¡®çº¿ç¨‹æ‰§è¡Œ
            Application.DocumentManager.MdiActiveDocument.SendStringToExecute(
                $"_MOVE {entityId.Handle} {fromPoint.X},{fromPoint.Y} {toPoint.X},{toPoint.Y} ",
                false, false, false);
            
            var duration = DateTime.Now - startTime;
            return AsyncOperationResult<bool>.Successful(true, duration);
        }
        catch (Exception ex)
        {
            var duration = DateTime.Now - startTime;
            return AsyncOperationResult<bool>.Failed(ex, duration);
        }
    }

    /// <summary>
    /// ä½¿ç”¨æ–‡æ¡£é”å®šçš„å®‰å…¨æ“ä½œ
    /// </summary>
    public async Task<T> ExecuteInDocumentContextAsync<T>(
        Document document, 
        Func<Transaction, T> operation, 
        CancellationToken cancellationToken = default)
    {
        var tcs = new TaskCompletionSource<T>();
        
        // åœ¨æ–‡æ¡£çš„åŒæ­¥ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ
        document.CommandStack.PushAsCurrentDocument(document);
        
        try
        {
            using (var docLock = document.LockDocument())
            using (var trans = document.TransactionManager.StartTransaction())
            {
                try
                {
                    var result = operation(trans);
                    trans.Commit();
                    tcs.SetResult(result);
                }
                catch (Exception ex)
                {
                    trans.Abort();
                    tcs.SetException(ex);
                }
            }
        }
        catch (Exception ex)
        {
            tcs.SetException(ex);
        }
        finally
        {
            document.CommandStack.PopAsCurrentDocument(document);
        }
        
        return await tcs.Task;
    }
}
```

### 2. å®ç°å‘½ä»¤å¼å¼‚æ­¥æ“ä½œ

```csharp
/// <summary>
/// åŸºäºå‘½ä»¤çš„å¼‚æ­¥æ“ä½œï¼ˆæ¨èæ–¹å¼ï¼‰
/// </summary>
public class CommandBasedAsyncService
{
    private readonly Dictionary<string, TaskCompletionSource<object>> _pendingOperations = new();

    public async Task<bool> MoveEntityAsync(ObjectId entityId, Point3d from, Point3d to)
    {
        var operationId = Guid.NewGuid().ToString();
        var tcs = new TaskCompletionSource<object>();
        _pendingOperations[operationId] = tcs;

        // æ„å»ºLISPå‘½ä»¤
        var command = $"(progn " +
                     $"(setq ent (handent \"{entityId.Handle}\")) " +
                     $"(if ent " +
                     $"  (progn " +
                     $"    (command \"_MOVE\" ent \"\" \"{from.X},{from.Y}\" \"{to.X},{to.Y}\") " +
                     $"    (princ \"SUCCESS_{operationId}\") " +
                     $"  ) " +
                     $"  (princ \"ERROR_{operationId}\") " +
                     $") " +
                     $")";

        // å‘é€å‘½ä»¤
        var doc = Application.DocumentManager.MdiActiveDocument;
        doc.SendStringToExecute(command, false, false, false);

        // ç­‰å¾…ç»“æœ
        var result = await tcs.Task;
        _pendingOperations.Remove(operationId);
        
        return result.ToString().StartsWith("SUCCESS");
    }
}
```

### 3. ä¿®å¤é™æ€å­—æ®µçº¿ç¨‹å®‰å…¨

```csharp
/// <summary>
/// çº¿ç¨‹å®‰å…¨çš„ARXç±»é‡æ„
/// </summary>
public static class ARX
{
    private static readonly Lazy<bool> _initialized = new Lazy<bool>(() => {
        ServiceInitializer.Initialize();
        return true;
    });

    /// <summary>
    /// çº¿ç¨‹å®‰å…¨çš„åˆå§‹åŒ–
    /// </summary>
    public static void Initialize(Action<IServiceContainer> configure = null)
    {
        lock (_initLock)
        {
            if (_initialized.Value) return;
            ServiceInitializer.Initialize(configure);
        }
    }

    /// <summary>
    /// çº¿ç¨‹å®‰å…¨çš„æœåŠ¡è®¿é—®
    /// </summary>
    public static ILogger Logger => 
        ServiceLocator.Current.GetService<ILogger>() ?? LogManager.DefaultLogger;
}
```

## å®æ–½å»ºè®®

### é˜¶æ®µ1: ç§»é™¤ç°æœ‰å¼‚æ­¥æ“ä½œ
1. åˆ é™¤ `AsyncOperations.cs` ä¸­çš„ `Task.Run` è°ƒç”¨
2. å°†å¼‚æ­¥æ–¹æ³•æ”¹ä¸ºåŸºäºå‘½ä»¤çš„å®ç°

### é˜¶æ®µ2: å®ç°æ–‡æ¡£é”å®šæœºåˆ¶
1. ä¸ºæ‰€æœ‰æ•°æ®åº“æ“ä½œæ·»åŠ æ–‡æ¡£é”å®š
2. å®ç°ä¸“ç”¨çš„æ–‡æ¡£ä¸Šä¸‹æ–‡æ‰§è¡Œå™¨

### é˜¶æ®µ3: å‘½ä»¤å¼å¼‚æ­¥é‡æ„
1. ä½¿ç”¨AutoCADå‘½ä»¤ç³»ç»Ÿå®ç°å¼‚æ­¥æ“ä½œ
2. é€šè¿‡LISP/å‘½ä»¤å›è°ƒè·å–æ“ä½œç»“æœ

è¿™ç§æ–¹æ¡ˆå®Œå…¨é¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ŒåŒæ—¶ä¿æŒäº†å¼‚æ­¥ç¼–ç¨‹çš„ç”¨æˆ·ä½“éªŒã€‚