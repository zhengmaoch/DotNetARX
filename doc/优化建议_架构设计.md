# ğŸ—ï¸ æ¶æ„è®¾è®¡ä¼˜åŒ–å»ºè®®

## å½“å‰æ¶æ„åˆ†æ

### ä¼˜åŠ¿
- âœ… æ¸…æ™°çš„åˆ†å±‚æ¶æ„
- âœ… ä¾èµ–æ³¨å…¥è®¾è®¡
- âœ… æ¥å£é©±åŠ¨å¼€å‘
- âœ… äº‹ä»¶é©±åŠ¨æ¶æ„

### é—®é¢˜
- âŒ è¿‡åº¦æŠ½è±¡å¯¼è‡´æ€§èƒ½æŸå¤±
- âŒ ç¼ºä¹ä¸“é—¨çš„AutoCADä¸Šä¸‹æ–‡ç®¡ç†
- âŒ çº¿ç¨‹æ¨¡å‹ä¸é€‚åˆAutoCAD
- âŒ ç¼ºä¹æ’ä»¶åŒ–æ¶æ„

## ä¼˜åŒ–åçš„æ¶æ„è®¾è®¡

### 1. ä¸‰å±‚æ¶æ„é‡æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              API å±‚ (ç”¨æˆ·æ¥å£)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ARX.Entity.Move()     â”‚  CAD.Move()         â”‚
â”‚ (å®Œæ•´åŠŸèƒ½API)          â”‚  (ç®€åŒ–API)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            æœåŠ¡ç¼–æ’å±‚                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ äº‹åŠ¡ç®¡ç†                                   â”‚
â”‚ â€¢ å¼‚å¸¸å¤„ç†                                   â”‚
â”‚ â€¢ æ€§èƒ½ç›‘æ§                                   â”‚
â”‚ â€¢ äº‹ä»¶å‘å¸ƒ                                   â”‚
â”‚ â€¢ ç¼“å­˜ç®¡ç†                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          AutoCAD æ“ä½œå±‚                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ç›´æ¥AutoCAD APIè°ƒç”¨                        â”‚
â”‚ â€¢ æœ€å°åŒ–æŠ½è±¡å¼€é”€                             â”‚
â”‚ â€¢ åŸç”Ÿæ€§èƒ½                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. AutoCADä¸Šä¸‹æ–‡ç®¡ç†å™¨

```csharp
/// <summary>
/// AutoCADä¸Šä¸‹æ–‡ç®¡ç†å™¨ - ç»Ÿä¸€ç®¡ç†AutoCADèµ„æº
/// </summary>
public sealed class CADContextManager : IDisposable
{
    private static readonly ThreadLocal<CADContextManager> _context = new();
    private readonly Database _database;
    private readonly Document _document;
    private readonly Transaction _transaction;
    private readonly DocumentLock _documentLock;
    private bool _disposed = false;

    private CADContextManager(Document document, bool needsLock = true)
    {
        _document = document ?? throw new ArgumentNullException(nameof(document));
        _database = document.Database;

        if (needsLock)
        {
            _documentLock = document.LockDocument();
        }

        _transaction = _database.TransactionManager.StartTransaction();
    }

    /// <summary>
    /// åˆ›å»ºCADä¸Šä¸‹æ–‡ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
    /// </summary>
    public static CADContextManager Create(Document document = null, bool needsLock = true)
    {
        document ??= Application.DocumentManager.MdiActiveDocument;
        if (document == null)
            throw new InvalidOperationException("æ— æ´»åŠ¨æ–‡æ¡£");

        var context = new CADContextManager(document, needsLock);
        _context.Value = context;
        return context;
    }

    /// <summary>
    /// è·å–å½“å‰çº¿ç¨‹çš„CADä¸Šä¸‹æ–‡
    /// </summary>
    public static CADContextManager Current => _context.Value;

    public Database Database => _database;
    public Document Document => _document;
    public Transaction Transaction => _transaction;

    /// <summary>
    /// è·å–å¯¹è±¡ï¼ˆå¼ºç±»å‹ï¼‰
    /// </summary>
    public T GetObject<T>(ObjectId objectId, OpenMode mode = OpenMode.ForRead) where T : DBObject
    {
        return _transaction.GetObject(objectId, mode) as T;
    }

    /// <summary>
    /// æäº¤äº‹åŠ¡
    /// </summary>
    public void Commit()
    {
        _transaction.Commit();
    }

    /// <summary>
    /// å›æ»šäº‹åŠ¡
    /// </summary>
    public void Abort()
    {
        _transaction.Abort();
    }

    public void Dispose()
    {
        if (!_disposed)
        {
            _transaction?.Dispose();
            _documentLock?.Dispose();
            _context.Value = null;
            _disposed = true;
        }
    }
}
```

### 3. é«˜æ€§èƒ½æ“ä½œåŸºç±»

```csharp
/// <summary>
/// é«˜æ€§èƒ½CADæ“ä½œåŸºç±»
/// </summary>
public abstract class FastCADOperation<TResult>
{
    protected readonly ILogger _logger;
    protected readonly IPerformanceMonitor _performanceMonitor;

    protected FastCADOperation(ILogger logger = null, IPerformanceMonitor performanceMonitor = null)
    {
        _logger = logger;
        _performanceMonitor = performanceMonitor;
    }

    /// <summary>
    /// æ‰§è¡Œæ“ä½œï¼ˆå¸¦æ€§èƒ½ç›‘æ§å’Œå¼‚å¸¸å¤„ç†ï¼‰
    /// </summary>
    public TResult Execute(params object[] parameters)
    {
        var operationName = GetType().Name;
        
        using var timer = _performanceMonitor?.StartTimer(operationName);
        
        try
        {
            var result = ExecuteCore(parameters);
            _logger?.LogInformation("æ“ä½œ {Operation} æ‰§è¡ŒæˆåŠŸ", operationName);
            return result;
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "æ“ä½œ {Operation} æ‰§è¡Œå¤±è´¥", operationName);
            throw;
        }
    }

    /// <summary>
    /// åœ¨CADä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œæ“ä½œ
    /// </summary>
    public TResult ExecuteInContext(Document document = null, params object[] parameters)
    {
        using var context = CADContextManager.Create(document);
        try
        {
            var result = ExecuteCore(parameters);
            context.Commit();
            return result;
        }
        catch
        {
            context.Abort();
            throw;
        }
    }

    /// <summary>
    /// å­ç±»å®ç°å…·ä½“æ“ä½œ
    /// </summary>
    protected abstract TResult ExecuteCore(params object[] parameters);
}
```

### 4. å®ä½“æ“ä½œå®ç°ç¤ºä¾‹

```csharp
/// <summary>
/// é«˜æ€§èƒ½å®ä½“ç§»åŠ¨æ“ä½œ
/// </summary>
public class FastMoveEntityOperation : FastCADOperation<bool>
{
    public FastMoveEntityOperation(ILogger logger = null, IPerformanceMonitor monitor = null) 
        : base(logger, monitor) { }

    protected override bool ExecuteCore(params object[] parameters)
    {
        var entityId = (ObjectId)parameters[0];
        var fromPoint = (Point3d)parameters[1];
        var toPoint = (Point3d)parameters[2];

        // å¿«é€Ÿé€€å‡ºæ¡ä»¶
        if (fromPoint.IsEqualTo(toPoint, 1e-10))
            return true;

        var context = CADContextManager.Current;
        if (context == null)
            throw new InvalidOperationException("å¿…é¡»åœ¨CADä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ");

        var entity = context.GetObject<Entity>(entityId, OpenMode.ForWrite);
        if (entity == null) return false;

        var displacement = toPoint - fromPoint;
        entity.TransformBy(Matrix3d.Displacement(displacement));

        return true;
    }
}

/// <summary>
/// æ‰¹é‡å®ä½“ç§»åŠ¨æ“ä½œ
/// </summary>
public class BatchMoveEntityOperation : FastCADOperation<int>
{
    protected override int ExecuteCore(params object[] parameters)
    {
        var operations = (IEnumerable<(ObjectId, Point3d, Point3d)>)parameters[0];
        var context = CADContextManager.Current;
        
        int successCount = 0;
        
        // æŒ‰ä½ç§»å‘é‡åˆ†ç»„ä¼˜åŒ–
        var grouped = operations.GroupBy(op => op.Item3 - op.Item2);
        
        foreach (var group in grouped)
        {
            var moveMatrix = Matrix3d.Displacement(group.Key);
            
            foreach (var (entityId, _, _) in group)
            {
                var entity = context.GetObject<Entity>(entityId, OpenMode.ForWrite);
                if (entity != null)
                {
                    entity.TransformBy(moveMatrix);
                    successCount++;
                }
            }
        }
        
        return successCount;
    }
}
```

### 5. ç®€åŒ–çš„APIé—¨é¢

```csharp
/// <summary>
/// ç®€åŒ–çš„é«˜æ€§èƒ½API
/// </summary>
public static class FastARX
{
    private static readonly ConcurrentDictionary<Type, object> _operationCache = new();

    private static T GetOperation<T>() where T : new()
    {
        return (T)_operationCache.GetOrAdd(typeof(T), _ => new T());
    }

    /// <summary>
    /// é«˜æ€§èƒ½å®ä½“ç§»åŠ¨
    /// </summary>
    public static bool MoveEntity(ObjectId entityId, Point3d from, Point3d to)
    {
        return GetOperation<FastMoveEntityOperation>().Execute(entityId, from, to);
    }

    /// <summary>
    /// åœ¨CADä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œæ“ä½œ
    /// </summary>
    public static TResult InContext<TResult>(Func<TResult> operation, Document document = null)
    {
        using var context = CADContextManager.Create(document);
        try
        {
            var result = operation();
            context.Commit();
            return result;
        }
        catch
        {
            context.Abort();
            throw;
        }
    }

    /// <summary>
    /// æ‰¹é‡æ“ä½œ
    /// </summary>
    public static void BatchOperation(Action<CADContextManager> operation, Document document = null)
    {
        using var context = CADContextManager.Create(document);
        try
        {
            operation(context);
            context.Commit();
        }
        catch
        {
            context.Abort();
            throw;
        }
    }
}
```

### 6. æ’ä»¶åŒ–æ¶æ„æ”¯æŒ

```csharp
/// <summary>
/// DotNetARXæ’ä»¶æ¥å£
/// </summary>
public interface IDotNetARXPlugin
{
    string Name { get; }
    Version Version { get; }
    void Initialize(IServiceCollection services);
    void Configure(IApplicationBuilder app);
}

/// <summary>
/// æ’ä»¶ç®¡ç†å™¨
/// </summary>
public class PluginManager
{
    private readonly List<IDotNetARXPlugin> _plugins = new();
    private readonly IServiceProvider _serviceProvider;

    public void LoadPlugin(IDotNetARXPlugin plugin)
    {
        _plugins.Add(plugin);
        
        var services = new ServiceCollection();
        plugin.Initialize(services);
        
        // åˆå¹¶æœåŠ¡åˆ°ä¸»å®¹å™¨
        var builder = new ContainerBuilder();
        builder.Populate(services);
        builder.Update(_serviceProvider as IContainer);
    }

    public IEnumerable<IDotNetARXPlugin> GetPlugins() => _plugins.AsReadOnly();
}

/// <summary>
/// ç¤ºä¾‹æ’ä»¶
/// </summary>
public class AdvancedGeometryPlugin : IDotNetARXPlugin
{
    public string Name => "Advanced Geometry Operations";
    public Version Version => new Version(1, 0, 0);

    public void Initialize(IServiceCollection services)
    {
        services.AddTransient<IAdvancedGeometryService, AdvancedGeometryService>();
    }

    public void Configure(IApplicationBuilder app)
    {
        // æ’ä»¶ç‰¹å®šé…ç½®
    }
}
```

### 7. é…ç½®é©±åŠ¨çš„æ¶æ„

```csharp
/// <summary>
/// DotNetARXé…ç½®
/// </summary>
public class DotNetARXOptions
{
    public bool EnablePerformanceMonitoring { get; set; } = true;
    public bool EnableEventSystem { get; set; } = true;
    public bool EnableCaching { get; set; } = true;
    public int CacheSize { get; set; } = 1000;
    public TimeSpan CacheExpiration { get; set; } = TimeSpan.FromMinutes(30);
    public LogLevel LogLevel { get; set; } = LogLevel.Information;
    public int ThreadPoolSize { get; set; } = Environment.ProcessorCount;
}

/// <summary>
/// é…ç½®é©±åŠ¨çš„åˆå§‹åŒ–
/// </summary>
public static class DotNetARXBuilder
{
    public static IServiceCollection AddDotNetARX(
        this IServiceCollection services, 
        Action<DotNetARXOptions> configure = null)
    {
        var options = new DotNetARXOptions();
        configure?.Invoke(options);

        services.AddSingleton(options);

        if (options.EnablePerformanceMonitoring)
        {
            services.AddSingleton<IPerformanceMonitor, AdvancedPerformanceMonitor>();
        }

        if (options.EnableEventSystem)
        {
            services.AddSingleton<IEventBus, MediatREventBus>();
        }

        if (options.EnableCaching)
        {
            services.AddMemoryCache(cache =>
            {
                cache.SizeLimit = options.CacheSize;
            });
        }

        return services;
    }
}
```

## ä½¿ç”¨ç¤ºä¾‹

### ç®€å•æ“ä½œ
```csharp
// è¶…ç®€åŒ–çš„APIè°ƒç”¨
FastARX.MoveEntity(entityId, from, to);

// åœ¨ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œå¤šä¸ªæ“ä½œ
FastARX.InContext(() =>
{
    FastARX.MoveEntity(id1, from1, to1);
    FastARX.MoveEntity(id2, from2, to2);
    return true;
});
```

### æ‰¹é‡æ“ä½œ
```csharp
// é«˜æ€§èƒ½æ‰¹é‡æ“ä½œ
FastARX.BatchOperation(context =>
{
    var operations = new[]
    {
        (id1, from1, to1),
        (id2, from2, to2),
        (id3, from3, to3)
    };
    
    var batchOp = new BatchMoveEntityOperation();
    batchOp.ExecuteCore(operations);
});
```

### æ’ä»¶æ‰©å±•
```csharp
// æ³¨å†Œæ’ä»¶
var pluginManager = new PluginManager();
pluginManager.LoadPlugin(new AdvancedGeometryPlugin());

// ä½¿ç”¨æ’ä»¶åŠŸèƒ½
var geometryService = ServiceLocator.GetService<IAdvancedGeometryService>();
```

## æ¶æ„ä¼˜åŠ¿

1. **æ€§èƒ½**: æœ€å°åŒ–æŠ½è±¡å±‚ï¼Œç›´æ¥è°ƒç”¨AutoCAD API
2. **çº¿ç¨‹å®‰å…¨**: æ­£ç¡®çš„CADä¸Šä¸‹æ–‡ç®¡ç†
3. **å¯æ‰©å±•**: æ’ä»¶åŒ–æ¶æ„æ”¯æŒ
4. **å¯é…ç½®**: é…ç½®é©±åŠ¨çš„åŠŸèƒ½å¼€å…³
5. **ç®€å•**: ä¸‰å±‚æ¸…æ™°æ¶æ„ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤

è¿™ç§æ¶æ„æ—¢ä¿æŒäº†ç°ä»£åŒ–çš„è®¾è®¡ç†å¿µï¼Œåˆé’ˆå¯¹AutoCADçš„ç‰¹æ®Šæ€§è¿›è¡Œäº†ä¼˜åŒ–ã€‚