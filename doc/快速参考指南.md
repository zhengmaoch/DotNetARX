# 🚀 DotNetARX 快速参考指南

## 📖 基础用法

### 初始化
```csharp
using DotNetARX;
ARX.Initialize(); // 可选，会自动初始化
```

### 实体操作
```csharp
// 创建和添加实体
var line = new Line(Point3d.Origin, new Point3d(100, 100, 0));
var entityId = ARX.ARXDatabase.AddToModelSpace(db, line);

// 基础变换
ARX.ARXEntity.Move(entityId, Point3d.Origin, new Point3d(50, 50, 0));
ARX.ARXEntity.Rotate(entityId, Point3d.Origin, Math.PI / 4);
ARX.ARXEntity.Scale(entityId, Point3d.Origin, 2.0);

// 复制和镜像
var copyId = ARX.ARXEntity.Copy(entityId, Point3d.Origin, new Point3d(100, 0, 0));
var mirrorId = ARX.ARXEntity.Mirror(entityId, Point3d.Origin, new Point3d(0, 100, 0));

// 偏移（仅限曲线）
var offsetIds = ARX.ARXEntity.Offset(entityId, 10.0);
```

### 异步操作
```csharp
// 异步实体操作
var result = await ARX.ARXEntityAsync.MoveAsync(entityId, from, to, cancellationToken);
if (result.Success)
    Console.WriteLine($"操作完成，耗时: {result.Duration.TotalMilliseconds}ms");

// 批量异步处理
var progress = new Progress<AsyncProgress>(p => 
    Console.WriteLine($"进度: {p.Percentage:F1}%"));

var results = await ARX.ARXEntityAsync.BatchOperationAsync(
    items, item => ProcessItem(item), progress, cancellationToken, maxConcurrency: 4);
```

## 🔧 工具函数

### 字符串工具
```csharp
ARX.String.IsNumeric("123.45");     // true
ARX.String.IsInteger("123");        // true
ARX.String.ToDoubleOrDefault("abc", 0.0); // 0.0
ARX.String.IsNullOrWhiteSpace("  "); // true
```

### 几何工具
```csharp
ARX.Geometry.IsValidCoordinate(point);        // 检查坐标有效性
ARX.Geometry.IsEqualTo(pt1, pt2, tolerance); // 点比较
```

## 📝 日志记录

```csharp
ARX.Logger.Debug("调试信息");
ARX.Logger.Info("一般信息");
ARX.Logger.Warning("警告信息");
ARX.Logger.Error("错误信息", exception);

// 或使用快捷方式
using static DotNetARX.CAD;
Log.Info("操作完成");
Log.Error("发生错误", ex);
```

## 📊 性能监控

```csharp
// 计时器
using (ARX.Performance.StartTimer("MyOperation"))
{
    // 您的代码
}

// 记录指标
ARX.Performance.RecordMetric("ProcessedItems", count);
ARX.Performance.IncrementCounter("UserActions");
ARX.Performance.IncrementErrorCounter("SaveErrors");

// 生成报告
var report = ARX.Performance.GenerateReport();

// 或使用快捷方式
using (Perf.Timer("Operation")) { /* 代码 */ }
Perf.Count("Actions");
Perf.Record("Items", 100);
```

## ⚙️ 配置管理

```csharp
// 读取配置
var batchSize = ARX.Config.GetSetting(ConfigurationKeys.DefaultBatchSize, 1000);
var customValue = ARX.Config.GetSetting("MyApp.Setting", "DefaultValue");

// 设置配置
ARX.Config.SetSetting("MyApp.MaxRetries", 3);
ARX.Config.SetSetting(ConfigurationKeys.LogLevel, "Debug");

// 保存配置
ARX.Config.Save();
```

## 🎯 事件系统

```csharp
// 订阅预定义事件
CADEventManager.EntityCreated += async args =>
{
    ARX.Logger.Info($"实体创建: {args.EntityId}");
};

CADEventManager.ErrorOccurred += async args =>
{
    ARX.Logger.Error($"错误发生: {args.ErrorMessage}");
};

// 触发事件
await CADEventManager.OnEntityCreatedAsync(entityId, "Line");
CADEventManager.OnEntityModified(entityId); // 同步版本

// 自定义事件处理
ARX.Events.Subscribe<EntityEventArgs>(async args =>
{
    // 处理逻辑
}, priority: (int)EventPriority.High);
```

## 🔗 依赖注入

```csharp
// 注册服务
ARX.Services.RegisterTransient<IMyService, MyService>();
ARX.Services.RegisterSingleton<ICache, MemoryCache>();

// 工厂注册
ARX.Services.RegisterFactory<IComplexService>(provider =>
{
    var config = provider.GetRequiredService<IConfigurationManager>();
    return new ComplexService(config);
});

// 获取服务
var service = ARX.Services.GetRequiredService<IMyService>();
var optionalService = ARX.Services.GetService<IOptionalService>();
```

## 🛡️ 异常处理

```csharp
// 自动异常处理
var result = CADExceptionHandler.ExecuteWithExceptionHandling(() =>
{
    // 可能抛出异常的代码
    return riskyOperation();
}, defaultValue);

// 包装操作并监控性能
ARX.WithPerformanceMonitoring(() =>
{
    // 您的操作
}, "OperationName", "Category");

// 手动抛出业务异常
CADExceptionHandler.ThrowEntityException("操作名称", entityId, "错误描述");
```

## 🧪 测试

```csharp
[TestClass("我的测试")]
public class MyTests
{
    [TestInitialize]
    public void Setup() => ARX.Initialize();

    [TestMethod("测试实体操作")]
    public void TestEntityOperation()
    {
        // 测试代码
        Assert.IsTrue(condition, "错误消息");
        Assert.AreEqual(expected, actual);
        Assert.ThrowsException<ArgumentException>(() => invalidOperation());
    }
}

// 运行测试
var results = ARX.Testing.RunAllTests();
var specificResult = ARX.Testing.RunTests<MyTests>();
```

## 🚀 简化API（CAD命名空间）

```csharp
using static DotNetARX.CAD;

// 实体操作
Entity.Move(id, from, to);
Entity.Copy(id, from, to);
Entity.Rotate(id, center, angle);

// 数据库操作  
DB.Add(database, entity);
DB.Add(database, entity1, entity2, entity3);

// 日志记录
Log.Info("消息");
Log.Error("错误", exception);

// 性能监控
using (Perf.Timer("Operation")) { /* 代码 */ }
Perf.Count("Counter");
```

## 📋 常用配置键

```csharp
// 预定义配置
ConfigurationKeys.DefaultBatchSize        // "CAD.DefaultBatchSize"
ConfigurationKeys.DefaultLayerName       // "CAD.DefaultLayerName" 
ConfigurationKeys.LogLevel               // "System.LogLevel"
ConfigurationKeys.EnableLogging          // "System.EnableLogging"
ConfigurationKeys.EnablePerformanceMonitoring // "Performance.EnableMonitoring"

// 使用示例
ARX.Config.SetSetting(ConfigurationKeys.LogLevel, "Debug");
ARX.Config.SetSetting(ConfigurationKeys.DefaultBatchSize, 500);
```

## 🔍 诊断工具

```csharp
// 系统状态检查
ARX.System.IsInitialized; // 检查是否已初始化

// 生成报告
var systemReport = ARX.System.GenerateReport();
var perfReport = ARX.System.GeneratePerformanceReport();

// 重置系统（测试用）
ARX.System.Reset();
```

## 💡 最佳实践

### 1. 错误处理
```csharp
// ✅ 推荐：使用异常处理包装器
var success = CADExceptionHandler.ExecuteWithExceptionHandling(() =>
{
    return riskyCadOperation();
}, false);

// ❌ 避免：裸露的CAD操作
var entity = transaction.GetObject(id, OpenMode.ForWrite); // 可能抛出异常
```

### 2. 资源管理
```csharp
// ✅ 推荐：使用增强事务管理器
using (var transManager = TransactionManagerFactory.Create(db))
{
    var entity = transManager.GetObject<Entity>(id, OpenMode.ForWrite);
    // 操作...
    transManager.Commit();
} // 自动释放

// ❌ 避免：手动事务管理
var trans = db.TransactionManager.StartTransaction();
try { /* ... */ trans.Commit(); } 
finally { trans.Dispose(); }
```

### 3. 批量操作
```csharp
// ✅ 推荐：批量添加
ARX.ARXDatabase.AddToModelSpace(db, entities);

// ❌ 避免：循环添加
foreach (var entity in entities)
    ARX.ARXDatabase.AddToModelSpace(db, entity);
```

### 4. 异步处理
```csharp
// ✅ 推荐：大量数据异步处理
await ARX.ARXEntityAsync.BatchOperationAsync(largeDataSet, processor, progress);

// ❌ 避免：同步处理大量数据
foreach (var item in largeDataSet) Process(item); // 阻塞UI
```

---

📚 **完整文档**: 参见 `README_完整文档.md`  
🐛 **问题排查**: 检查日志文件或运行 `ARX.System.GenerateReport()`